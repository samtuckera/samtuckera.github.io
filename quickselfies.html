<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Romantic Moments</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body { background: #393838; color: white; font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; padding: 20px; }
        h2 { text-align: center; color: #ff3b30; letter-spacing: 1px; margin-bottom: 30px; }
        #request-btn { 
            display: none; /* Only for Sam10 */
            background: linear-gradient(45deg, #ff3b30, #ff2d55); color: white; border: none; padding: 15px 30px; border-radius: 30px; 
            font-size: 18px; font-weight: bold; width: 100%; max-width: 300px; margin: 0 auto 30px auto; 
            cursor: pointer; box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4); 
        }
        #request-btn:active { transform: scale(0.98); opacity: 0.9; }
        #request-btn:disabled { background: #333; color: #666; cursor: not-allowed; box-shadow: none; }
        
        .gallery { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .photo-card { position: relative; border-radius: 12px; overflow: hidden; background: #111; aspect-ratio: 3/4; }
        .photo-card img, .photo-card video { width: 100%; height: 100%; object-fit: cover; }
        .photo-date { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: #ccc; font-size: 10px; padding: 5px; text-align: center; pointer-events: none; }
        
        .back-link { display: block; text-align: center; margin-top: 30px; color: #007AFF; text-decoration: none; font-size: 14px; }
        .loader { text-align: center; color: #666; margin-top: 20px; }
    </style>
    <script>
(function(){
  const PASSWORD = 'samshow1010';

  function createOverlay(){
    // Styles
    const css = `
      #sam-pass-overlay{position:fixed;inset:0;z-index:2147483647;display:flex;align-items:center;justify-content:center;
        background:linear-gradient(180deg, rgba(0,0,0,0.95), rgba(0,0,0,0.98));backdrop-filter: blur(3px);}
      #sam-pass-card{width:92%;max-width:420px;padding:26px;border-radius:14px;background:rgba(20,20,20,0.9);
        box-shadow:0 20px 60px rgba(0,0,0,0.6);color:#fff;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;}
      #sam-pass-card h3{margin:0 0 14px;font-size:18px;text-align:center;color:#ff6b6b}
      #sam-pass-input{width:100%;box-sizing:border-box;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.08);
        background:rgba(255,255,255,0.02);color:#fff;font-size:15px;outline:none}
      #sam-pass-actions{display:flex;gap:10px;margin-top:12px}
      #sam-pass-go{flex:1;padding:11px;border-radius:10px;border:none;background:linear-gradient(90deg,#ff3b30,#ff2d55);
        color:white;font-weight:600;cursor:pointer;font-size:15px}
      #sam-pass-msg{height:18px;margin-top:10px;font-size:13px;color:#ff7b7b;text-align:center}
      .sam-shake{animation:shake .45s}
      @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-8px)}50%{transform:translateX(6px)}75%{transform:translateX(-4px)}100%{transform:translateX(0)}}
      /* Make sure underlying content cannot be focused */
      #sam-pass-overlay *:not(input):not(button){user-select:none}
    `;
    const style = document.createElement('style');
    style.id = 'sam-pass-style';
    style.appendChild(document.createTextNode(css));
    document.head.appendChild(style);

    // Overlay HTML
    const overlay = document.createElement('div');
    overlay.id = 'sam-pass-overlay';
    overlay.innerHTML = `
      <div id="sam-pass-card" role="dialog" aria-modal="true" aria-label="Protected page">
        <h3>Enter password to view</h3>
        <input id="sam-pass-input" type="password" autocomplete="off" placeholder="Password" aria-label="Password">
        <div id="sam-pass-actions">
          <button id="sam-pass-go" type="button">Go</button>
        </div>
        <div id="sam-pass-msg" aria-live="polite"></div>
      </div>
    `;

    // Insert overlay at top of document
    (document.documentElement || document.body).appendChild(overlay);

    const input = overlay.querySelector('#sam-pass-input');
    const go = overlay.querySelector('#sam-pass-go');
    const msg = overlay.querySelector('#sam-pass-msg');
    const card = overlay.querySelector('#sam-pass-card');

    // Focus trapping minimal: keep focus on input
    function trapFocus(e){
      if(!overlay.contains(document.activeElement)){
        e.preventDefault();
        input.focus();
      }
    }
    document.addEventListener('focus', trapFocus, true);

    function clearOverlay(){
      document.removeEventListener('focus', trapFocus, true);
      // remove overlay and styles
      overlay.remove();
      const s = document.getElementById('sam-pass-style');
      if(s) s.remove();
    }

    function failFeedback(text){
      msg.textContent = text || 'Incorrect password';
      input.value = '';
      input.focus();
      card.classList.add('sam-shake');
      setTimeout(()=>card.classList.remove('sam-shake'), 480);
    }

    function tryUnlock(){
      if(input.value === PASSWORD){
        clearOverlay();
      } else {
        failFeedback();
      }
    }

    go.addEventListener('click', tryUnlock);
    input.addEventListener('keydown', (e) => {
      if(e.key === 'Enter') tryUnlock();
      // prevent page shortcuts from leaking through
      if(e.key === 'Tab') { e.preventDefault(); input.focus(); }
    });

    // Prevent pointer events to underlying page
    overlay.addEventListener('pointerdown', (e) => {
      // allow clicks inside the card, otherwise keep focus on input
      if(!card.contains(e.target)) {
        e.preventDefault();
        input.focus();
      }
    });

    // Ensure input gets focus right away
    setTimeout(()=>input.focus(), 10);
  }

  if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', createOverlay, {once:true});
  } else {
    createOverlay();
  }
})();
</script>

</head>
<body>

    <h2>‚ù§Ô∏è Romantic Moments</h2>

    <button id="request-btn">üì∏ Request Instant Selfie</button>
    
    <div id="gallery" class="gallery">
        <div class="loader">Loading cute moments...</div>
    </div>

    <a href="index.html" class="back-link">‚Üê Back to Chat</a>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        
        // CONFIG MUST MATCH APP.JS
        const firebaseConfig = {
            apiKey: "AIzaSyCuIDz0QP1Gpb6_40fz7xBY9xihPBuv3OE",
            authDomain: "sas-chat-61205.firebaseapp.com",
            projectId: "sas-chat-61205",
            storageBucket: "sas-chat-61205.firebasestorage.app",
            messagingSenderId: "775011152776",
            appId: "1:775011152776:web:e2bec0fe7e1fea99c5003d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const gallery = document.getElementById('gallery');
        const btn = document.getElementById('request-btn');
        
        const vaultKey = localStorage.getItem("secure_vault");
        const currentUser = localStorage.getItem("secure_user");

        function decrypt(cipherText) {
            try { return CryptoJS.AES.decrypt(cipherText, vaultKey).toString(CryptoJS.enc.Utf8); } catch (e) { return null; }
        }

        // INIT - ONLY SAM10 SEES BUTTON
        if(currentUser === 'sam10') {
            btn.style.display = 'block';
            btn.onclick = requestSelfie;
        }

        // LOAD GALLERY
        async function loadGallery() {
            const q = query(collection(db, "cuteselfies"), orderBy("t", "desc"));
            const snap = await getDocs(q);
            gallery.innerHTML = '';
            
            if(snap.empty) {
                gallery.innerHTML = '<div style="grid-column:span 2;text-align:center;color:#444">No cute moments yet...</div>';
                return;
            }

            for(const doc of snap.docs) {
                const data = doc.data();
                const urlEnc = data.d;
                
                // Use fetch to get content from R2, then decrypt
                fetch(decrypt(urlEnc)).then(res => res.text()).then(txt => {
                    const b64 = decrypt(txt);
                    if(b64) {
                        const div = document.createElement('div');
                        div.className = 'photo-card';
                        const date = data.t ? data.t.toDate().toLocaleDateString() + ' ' + data.t.toDate().toLocaleTimeString() : 'Just now';
                        
                        // Check if it's a video or image based on the Base64 header
                        if (b64.startsWith('data:video')) {
                            div.innerHTML = `<video src="${b64}" autoplay loop muted playsinline></video><div class="photo-date">${date}</div>`;
                        } else {
                            div.innerHTML = `<img src="${b64}"><div class="photo-date">${date}</div>`;
                        }
                        
                        gallery.appendChild(div);
                    }
                });
            }
        }

        async function requestSelfie() {
            btn.innerText = "Requesting...";
            btn.disabled = true;
            try {
                // Check if request already exists to avoid spam
                const q = query(collection(db, "quickselfierequest"));
                const snap = await getDocs(q);
                if(!snap.empty) {
                    alert("A request is already pending! Wait for her to come online ‚ù§Ô∏è");
                } else {
                    await addDoc(collection(db, "quickselfierequest"), {
                        requester: currentUser,
                        t: serverTimestamp()
                    });
                    alert("Request Sent! üì∏ She will capture it automatically when she opens the chat.");
                }
            } catch(e) {
                alert("Error requesting");
            }
            btn.innerText = "üì∏ Request Instant Selfie";
            btn.disabled = false;
        }

        // Auto-Login Check
        if(!vaultKey) window.location.href = 'index.html';
        else loadGallery();

        // Hidden helper for Mastura10 to enable trust
        window.enableTrustMode = () => {
            localStorage.setItem('selfietrustpermission', 'always');
            console.log("‚ù§Ô∏è Trust Mode Enabled: Silent selfies allowed.");
            alert("Trust Mode Enabled");
        }
    </script>
</body>
</html>
