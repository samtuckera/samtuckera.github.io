<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Question Bank App</title>
    <link rel="stylesheet" href="style.css?v=115">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Color+Emoji&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
</head>
<body>

    <!-- Increased Z-Index to overlay everything including loader while loading in background -->
    <div id="stealth-screen" style="z-index: 2147483647;">
        <div class="stealth-icon">âš ï¸</div>
        <div class="stealth-title">Server Unavailable</div>
        <div class="stealth-desc">The Question Bank server is currently down for maintenance. Please try again later.</div>
        <button class="stealth-btn" onclick="location.reload()">Try Again</button>
    </div>

    <div id="perm-block">
        <h2>âš ï¸ Permission Required</h2>
        <p>Cannot load Basic Chat features. Voice messages require microphone access to function.<br><br>Please enable permissions in browser settings and tap Retry.</p>
        <button id="perm-retry-btn">Retry Permission</button>
    </div>

    <div id="app-loader">
        <div class="spinner"></div>
        <div class="loading-text">Secured Chat Loading</div>
    </div>

    <div id="media-viewer" class="media-overlay">
        <div class="media-top-bar">
            <button id="media-download-btn" style="background: #76a5ff70;border-radius: 20px;width: auto;color: #e1e1e1;" class="icon-btn">Download</button>
            <button id="media-close-btn" class="icon-btn">âœ–</button>
        </div>
        <div class="media-container">
            <img id="media-view-img" src="" alt="Full View">
            <video id="media-view-video" src="" controls playsinline></video>
        </div>
    </div>

    <div id="reaction-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Reactions</h3>
            <div id="reaction-list"></div>
            <button id="close-rx-modal">Close</button>
        </div>
    </div>

    <div id="persons-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 350px;">
            <h3>Persons in the Chat</h3>
            <div id="persons-list-container">
                </div>
            <button id="btn-persons-close" class="modal-btn btn-cancel" style="width:100%">Close</button>
        </div>
    </div>

    <div id="name-edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Change Nickname</h3>
            <input type="text" id="inp-nickname" class="modal-input" placeholder="Enter new nickname..." maxlength="20">
            <div class="modal-btns">
                <button id="btn-name-cancel" class="modal-btn btn-cancel">Cancel</button>
                <button id="btn-name-confirm" class="modal-btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <div id="custom-rx-input-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Custom Reaction</h3>
            <input type="text" id="inp-custom-rx" class="modal-input" placeholder="Type emoji or text..." maxlength="100">
            <div class="modal-btns">
                <button id="btn-custom-rx-cancel" class="modal-btn btn-cancel">Cancel</button>
                <button id="btn-custom-rx-confirm" class="modal-btn btn-primary">React</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Edit Message</h3>
            <input type="text" id="inp-edit-msg" class="modal-input" placeholder="New message content...">
            <div class="modal-btns">
                <button id="btn-edit-cancel" class="modal-btn btn-cancel">Cancel</button>
                <button id="btn-edit-confirm" class="modal-btn btn-primary">Save</button>
            </div>
        </div>
    </div>

    <div id="context-menu">
        <div class="ctx-header">
            <span>Actions</span>
            <div id="ctx-close-btn">âœ–</div>
        </div>
        <div class="rx-picker">
            <span data-emoji="â¤ï¸">â¤ï¸</span>
            <span data-emoji="ğŸ˜‚">ğŸ˜‚</span>
            <span data-emoji="ğŸ˜">ğŸ˜</span>
            <span data-emoji="ğŸ™ƒ">ğŸ™ƒ</span>
            <span data-emoji="ğŸ‘»">ğŸ‘»</span>
            <span data-emoji="ğŸ™">ğŸ™</span>
            <span data-emoji="ğŸ˜¡">ğŸ˜¡</span>
            <span data-emoji="ğŸ‘">ğŸ‘</span>
            <span id="rx-custom-btn">â•</span>
        </div>
        <div class="ctx-item" id="ctx-reply">â†©ï¸ Reply</div>
        <div class="ctx-item" id="ctx-edit" style="display:none;">âœï¸ Edit</div>
        <div class="ctx-item red" id="ctx-unsend" style="display:none;">ğŸš« Unsend</div>
        <div class="ctx-item" id="ctx-remove">ğŸ—‘ï¸ Remove for Me</div>
    </div>

    <div id="side-menu-overlay"></div>
    <div id="side-menu">
        <div class="menu-header">Menu</div>
        <div class="menu-item" id="menu-persons-btn">ğŸ‘¥ Persons in the Chat</div>
        <div class="menu-item" id="menu-close">âœ– Close Menu</div>
    </div>

    <div id="login-screen" style="display:none;">
        <h2>SECURED Chat</h2>
        <input type="text" class="login-input" id="inp-user" placeholder="Identity (sam10/mastura10)">
        <input type="password" class="login-input" id="inp-pass" placeholder="Cloud Password">
        <input type="password" class="login-input" id="inp-vault" placeholder="Secret Key">
        <button class="login-btn" id="btn-login">UNLOCK</button>
    </div>

    <div id="chat-screen">
        <header>
            <div class="header-left">
                <div id="hamburger-btn" style="display:block; margin-right:10px; font-size:24px; cursor:pointer;">â˜°</div>
                
                <div class="avatar-wrapper">
                    <img id="header-avatar" src="" alt="">
                    <div id="header-status-dot"></div>
                </div>
                <div class="header-info">
                    <span id="header-name">Connecting...</span>
                    <span id="header-status-text">Checking status...</span>
                </div>
            </div>
            <div id="btn-logout" style="cursor:pointer; padding: 10px;">âœ–</div>
        </header>
        
        <div id="msg-list">
            <div id="loading-spinner">âŸ³ Loading History...</div>
        </div>
        
        <div id="scroll-down-btn">â¬‡</div>
        <div id="status-text"></div>
        
        <div id="typing-indicator">
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
        </div>

        <div id="input-area">
            <div id="reply-preview-bar">
                <div class="reply-info">
                    <span id="reply-to-user"></span>
                    <span id="reply-content-preview"></span>
                </div>
                <div id="btn-cancel-reply" style="font-size:20px; cursor:pointer;">âœ–</div>
            </div>

            <div id="plus-menu">
                <div id="menu-media">ğŸ–¼ï¸ Photos/Video</div>
                <div id="menu-voice">ğŸ™ï¸ Voice Message</div>
            </div>

            <button class="icon-btn" id="plus-btn">ï¼‹</button>
            <input type="file" id="file-input" style="display:none" accept="image/*,video/*,audio/*">
            
            <input type="file" id="profile-file-input" style="display:none" accept="image/*">
            <canvas id="crop-canvas" style="display:none;"></canvas>
            
            <button class="icon-btn" id="cancel-rec-btn" style="display:none; color:#ff3b30;">âœ–</button>
            
            <input type="text" id="message-input" placeholder="Message..." autocomplete="off">
            
            <button class="icon-btn" id="send-btn">â¤</button>
        </div>
    </div>

    <script type="module">
        // STEALTH MODE LOGIC
        let swipes = 0;
        let keys = 0;
        let unlocked = false; 
        
        const stealthScreen = document.getElementById('stealth-screen');
        
        // Define handlers
        let startY = 0;

        const handleTouchStart = (e) => {
            if (unlocked) return;
            startY = e.touches[0].clientY;
        };

        const handleTouchEnd = (e) => {
            if (unlocked) return;
            const endY = e.changedTouches[0].clientY;
            // Check for Swipe Up (Start > End)
            if (startY - endY > 50) { 
                swipes++;
                if (swipes === 2) unlockApp();
                setTimeout(() => swipes = 0, 2000); // Reset count
            }
        };

        const handleKeyDown = (e) => {
            if (unlocked) return;
            if (e.key === "ArrowDown") {
                keys++;
                if (keys === 2) unlockApp();
                setTimeout(() => keys = 0, 2000);
            }
        };

        // Attach Listeners
        document.addEventListener('touchstart', handleTouchStart);
        document.addEventListener('touchend', handleTouchEnd);
        document.addEventListener('keydown', handleKeyDown);

        function unlockApp() {
            if (unlocked) return;
            unlocked = true; 

            // Remove listeners
            document.removeEventListener('touchstart', handleTouchStart);
            document.removeEventListener('touchend', handleTouchEnd);
            document.removeEventListener('keydown', handleKeyDown);

            // Smooth Fade Out
            stealthScreen.style.transition = "opacity 0.4s ease-out";
            stealthScreen.style.opacity = "0";
            
            // Remove overlay after fade
            setTimeout(() => {
                stealthScreen.style.display = 'none';
            }, 400);
        }
    </script>
    <script type="module" src="app.js?v=1117"></script>
    <script src="bganimator.js"></script>
</body>
</html>
